<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CSV Processor</title>
	<link rel="stylesheet" href="csvProcessor.css">
	<script src="encoding.js-master/encoding.min.js"></script>
	<script src="csvProcessor.js"></script>
</head>
<body>
	<div id="header">
		<div id="headerTitle">CSV Processor</div>
		<div id="profileMenu">
			<div id="profileMenuTitle">プロファイル操作：</div>
			<div class="profileMenuComment">
				ブラウザ内から選ぶ
			</div>
			<select id="profileSelect">
				<option value="default">デフォルト</option>
			</select>
			<button id="profileLoadButton">開く</button>
			<button id="profileRemoveButton">削除</button>
			<div class="profileMenuComment">
				ブラウザに保存
			</div>
			<button id="profileSaveButton">保存</button>
			<div class="profileMenuComment">
				ファイル
			</div>
			<button id="profileImportButton">インポート</button>
			<button id="profileExportButton">エクスポート</button>
		</div>
	</div>
	<div id="content">
		<div id="contentTitleBox">
			<div id="contentTitle">
				CSV Processor
			</div>
			<div id="contentDescription">
				多量・巨大なCSVを自在に処理するツール
			</div>
		</div>
		<div id="stepBox">
			<div id="step1" class="step">
				<h2>Step1: Input <span class="stepSubTitle">入力</span></h2>
				<h3>読み込み方法の設定</h3>
				<div>
					<div class="optionSet">
						<label class="optionBox"><input type="radio" name="inputMethod" value="file" checked data-option="inputMethod"> ファイルを読み込む</label>
						<label class="optionBox">
							ファイルを選択：<input type="file" id="selectFileButton" accept=".csv" multiple>
						</label>
					</div>
					<div class="optionSet">
						<label class="optionBox"><input type="radio" name="inputMethod" value="directory" data-option="inputMethod"> フォルダを読み込む</label>
						<label class="optionBox">
							フォルダを選択：
							<button id="inputDirectorySelectButton" disabled>フォルダを選択</button>
						</label>
						<label class="optionBox">
							読み込みフィルタ(RegExp):<input type="text" id="inputFileRegExpInput" value=".csv$" style="width: 5em;" disabled data-option="inputFileRegExp">
						</label>
						<button id="directoryReloadButton" disabled>再読込</button>
						<span id="inputDirectoryStatusText">－</span>
					</div>
					<div class="optionSet">
						<label class="optionBox"><input type="radio" name="inputMethod" value="direct" data-option="inputMethod"> 直接入力</label><br>
						<textarea id="inputCsvTextInput" rows="10" cols="50" placeholder="ここに直接入力することもできます" data-option="inputCsvText"></textarea>
					</div> 
					
				</div>
				
				<h3>読み込みオプション</h3>
				<div id="inputOptions">
					プレビューを見ながら、正常に読み込まれるように設定してください。<br>
					<table id="inputOptionTable">
						<tr>
							<th>文字コード</th>
							<td>
								<select id="inputEncodingSelect" data-option="inputEncoding">
									<option value="utf-8" selected>UTF-8</option>
									<option value="shift-jis">Shift_JIS</option>
									<option value="euc-jp">EUC-JP</option>
									<option value="iso-2022-jp">ISO-2022-JP</option>
									<option value="utf-16be">UTF-16be</option>
									<option value="utf-16le">UTF-16le</option>
									<option value="AUTO">自動判定(低速)</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>区切り文字</th>
							<td><label>区切り文字：<input type="text" id="inputDelimiterInput" value="," style="width: 3em;" data-option="inputDelimiter"></label></td>
						</tr>
						<tr>
							<th>改行文字</th>
							<td>
								「CRLF」で正常に読み込めない場合のみ変更してください。<br>
								<select id="inputLineBreakInput" data-option="inputLineBreakSelect">
									<option value="ALL" selected>CR,LF,CRLF</option>
									<option value="CRLF"selected>CRLF</option>
									<option value="CR">CR</option>
									<option value="LF">LF</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>先頭スキップ</th>
							<td><label><input type="number" id="inputSkipRowNumberInput" value="0" style="width: 3em;" min="0" data-option="inputSkipRowNumber">行を読み飛ばす</label></td>
						</tr>
						<tr>
							<th>空行</th>
							<td><label><input type="checkbox" id="inputSkipEmptyRowCheckbox" data-option="inputSkipEmptyRow">空の行を読み飛ばす</label></td>
						</tr>
						<tr>
							<th>タイトル行</th>
							<td><label><input type="checkbox" id="inputIsUsingHeaderCheckbox" data-option="inputIsUsingHeader">先頭行をタイトル行として扱う</label></td>
						</tr>
						<tr>
							<th>囲み文字</th>
							<td>
								<label><input type="checkbox" id="inputIsUsingWrapperCheckbox" checked data-option="inputIsUsingWrapper">囲み文字を使用</label><br>
								<label>囲み文字：<input type="text" id="wrapperInput" value='"' style="width: 3em;" data-option="inputWrapper"></label>
							</td>
						</tr>
						<tr>
							<th>セル内の特殊文字</th>
							<td>
								<label><input type="checkbox" id="inputIsUsingLineBreakInWrapperCheckbox" data-option="inputIsUsingLineBreakInWrapper">セル内に改行文字を含む</label><br>
								<label><input type="checkbox" id="inputIsUsingDelimiterInWrapperCheckbox" data-option="inputIsUsingDelimiterInWrapper">セル内に区切り文字を含む</label>
								<div class="tooltip">？<div class="tooltipText">
									読み込みに必要な時間が大幅に増加します。<br>必要な場合のみチェックしてください。
								</div></div>
								<br>
								<label><input type="checkbox" id="inputIsUsingWrapperInWrapperCheckbox" checked data-option="inputIsUsingWrapperInWrapper">セル内に囲み文字を含む</label>
								<div class="tooltip">？<div class="tooltipText">
									読み込みに必要な時間が大幅に増加します。<br>必要な場合のみチェックしてください。
								</div></div>
							</td>
						</tr>
						<tr>
							<th>末尾の改行</th>
							<td><label><input type="checkbox" id="inputIgnoreLastLineBreakCheckbox" checked data-option="inputIgnoreLastLineBreak">入力末尾の改行は無視</label></td>
						</tr>
						<tr>
							<th>処理方法</th>
							<td>
								<label><input type="checkbox" id="inputLoadOnceCheckBox" data-option="inputLoadOnce">ファイルを分割せず読み込む</label>
								<div class="tooltip">？<div class="tooltipText">
									本ツールでは通常、メモリ不足防止のため、ファイルを分割して読み込みます。<br>
									読み込んだファイルに対してソート処理などをする場合のみチェックしてください。<br>
									処理するファイルが大きい場合はメモリ不足となる場合があります。
								</div></div>
							</td>
						</tr>
					</table>
				</div>
				<h3>プレビュー表示</h3>
				<div>
					<label class="optionBox">文字数リミット : <input type="number" id="inputPreviewCharLimitInput" value="1000" style="width: 5em;">文字</label><br>
					<span id="readingModeView">処理モードを表示</span><!-- ★ -->
					<div id="inputPreviewBox">
						<table id="inputPreviewTable"></table>
					</div>
				</div>
			</div>
			<div id="step2" class="step">
				<h2>Step2: Process <span class="stepSubTitle">処理</span></h2>
				<h3>入力ファイル(チャンク)単位での処理</h3>
				<p>
					ここで使える変数
					<table>
						<tr><th>file</th><td></td></tr>
						<tr><th>fileObj</th><td>Fileオブジェクト</td></tr>
						<tr><th>csvIndex</th><td>入力ファイルのインデックス(何番目か)</td></tr>
						<tr><th>csvText</th><td>入力ファイルのテキスト</td></tr>
						<tr><th>csvArray</th><td>入力ファイルをCSVとしてパースした結果のオブジェクト(セルごと)</td></tr>
						<tr><th>rowTextArray</th><td>入力ファイルをCSVとしてパースした結果のオブジェクト(行ごと)</td></tr>
						<tr><th>options</th><td>現在の各設定値</td></tr>
						<tr><th>allLoaded</th><td>1チャンクで全てのデータが読み込まれた</td></tr>
						<tr><th>completed</th><td>ファイル読み込み完了(これが最後のチャンク)</td></tr>
						<tr><th>firstLoad</th><td>最初の読み込み(これが最初のチャンク)</td></tr>
						<tr><th>sessionRowCount</th><td>セッション内の累計読込行数(最初の行は0)</td></tr>
					</table>
					配列を返すことで、csvArrayを書き換えることが可能
				</p>
				<div id="perInputProcesses">
					<div class="perInputProcess" data-perInputProcessNum="0" data-perInputProcessType="perInputCode">
						<textarea class="code" data-processOption="perInputCode" data-option="perInputCode"></textarea>
					</div>
				</div>
				<h3>行ごとに実行する処理</h3>
				<p>
					ここで使える変数(前述に加えて)
					<table>
						<tr><th>rowIndex</th><td>行インデックス(何行目か) チャンク分割を考慮</td></tr>
						<tr><th>rowArray</th><td>行のオブジェクト(セルごと)</td></tr>
						<tr><th>rowText</th><td>行のテキスト</td></tr>
					</table>
					配列を返すことで、rowArrayを書き換えることが可能
				</p>
				<div id="perRowProcesses">
					<div class="perRowProcess" data-perRowProcessNum="0" data-perRowProcessType="perRowCode">
						<textarea class="code" data-processOption="perRowCode" data-option="perRowCode"></textarea>
					</div>
				</div>
				<h3>セルごとに実行する処理</h3>
				<p>
					ここで使える変数(前述に加えて)
					<table>
						<tr><th>cellIndex</th><td>セルのインデックス(何列目か)</td></tr>
						<tr><th>cellText</th><td>セルのテキスト</td></tr>
					</table>
					文字列・数値・真偽値を返すことで、cellTextを書き換えることが可能
				</p>
				<div id="perCellProcesses">
					<div class="perCellProcess" data-perCellProcessNum="0" data-perCellProcessType="perCellCode">
						<textarea class="code" data-processOption="perCellCode" data-option="perCellCode"></textarea>
					</div>
				</div>
				<h3>出力ファイル(チャンク)ごとに実行する処理</h3>
				<p>
					ここで使える変数
					<table>
						<tr><th>rowArrays</th><td>書き込み予定のデータ(2次元)</td></tr>
					</table>
				</p>
				<div id="perOutputProcesses">
					<div class="perOutputProcess" data-perOutputProcessNum="0" data-perOutputProcessType="perOutputCode">
						<textarea class="code" data-processOption="perOutputCode" data-option="perOutputCode"></textarea>
					</div>
				</div>
			</div>
			<div id="step3" class="step">
				<h2>Step3 : Output <span class="stepSubTitle">出力</span></h2>
				<h3>出力プレビュー</h3>
				<div>
					<!-- <label class="optionBox">文字数リミット : <input type="number" id="outputPreviewCharLimitInput" value="1000" style="width: 5em;">文字</label><br> -->
					<div id="outputPreviewBox">
						<table id="outputPreviewTable"></table>
					</div>
				</div>
				
				<h3>出力方法の設定</h3>
				<div class="optionSet">
					<label class="optionBox"><input type="radio" name="outputMethod" value="direct" data-option="outputMethod"> 直接出力</label><br>
					<textarea id="csvTextOutputTextarea" rows="10" cols="50" placeholder="ここに出力が表示されます"></textarea>
				</div>
				<div class="optionSet">
					<label class="optionBox"><input type="radio" name="outputMethod" value="directory" checked data-option="outputMethod"> フォルダに出力</label>
					<button id="outputDirectorySelectButton">フォルダを選択</button>
					<span id="outputDirectoryStatusText">－</span>
				</div>
				
				<h3>出力オプション</h3>
				<table id="outputOptionTable">
					<tr>
						<th>文字コード</th>
						<td>
							<select id="outputEncodingSelect" data-option="outputEncoding">
								<option value="UTF-8" selected>UTF-8</option>
								<option value="SJIS">Shift_JIS</option>
								<option value="EUCJP">EUC-JP</option>
								<option value="JIS">ISO-2022-JP</option>
								<!-- <option value="UTF16">UTF-16</option> -->
								<option value="UTF16BE">UTF-16be</option>
								<option value="UTF16LE">UTF-16le</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>区切り文字</th>
						<td>
							<label>区切り文字：<input type="text" id="outputDelimiterInput" value="," style="width: 3em;" data-option="outputDelimiter"></label>
						</td>
					</tr>
					<tr>
						<th>改行文字</th>
						<td>
							<select id="outputLineBreakInput" data-option="outputLineBreakSelect">
								<option value="CRLF" selected>CRLF</option>
								<option value="CR">CR</option>
								<option value="LF">LF</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>囲み文字</th>
						<td>
							<label><input type="checkbox" id="outputIsUsingWrapperCheckbox" checked data-option="outputIsUsingWrapper">囲み文字を使用</label><br>
							<label>囲み文字：<input type="text" id="outputWrapperInput" value='"' style="width: 3em;" data-option="outputWrapper"></label><br>
							<label><input type="checkbox" id="outputIsUsingWrapperAllCheckbox" data-option="outputIsUsingWrapperAll">すべてのセルに囲み文字を使用</label><br>
						</td>
					</tr>
					<tr>
						<th>タイトル行</th>
						<td><label><input type="checkbox" id="outputIsUsingHeaderCheckbox" data-option="outputIsUsingHeader">先頭にタイトル行を出力</label>
						</td>
					</tr>
					<tr>
						<th>末尾の改行</th>
						<td><label><input type="checkbox" id="outputAddLastLineBreakCheckbox" checked data-option="outputAddLastLineBreak">出力末尾に改行をつける</label></td>
					</tr>
					<tr>
						<th>セル内の特殊文字</th>
						<td>
							<label><input type="checkbox" id="outputIsUsingSpecialCharacterInWrapperCheckbox" data-option="outputIsUsingSpecialCharacterInWrapper">セル内に改行・区切り文字・囲み文字を含む</label>
						</td>
					</tr>
					<tr>
						<th>先頭にテキスト追加</th>
						<td>
							<textarea id="outputPrefixTextTextarea" rows="2" cols="50" placeholder="出力ファイルの先頭に追加するテキストを入力してください。多くの場合、末尾に改行が必要です" data-option="outputPrefixText"></textarea>
						</td>
					</tr>
					<tr>
						<th>末尾にテキスト追加</th>
						<td>
							<textarea id="outputSuffixTextTextarea" rows="2" cols="50" placeholder="出力ファイルの末尾に追加するテキストを入力してください" data-option="outputSuffixText"></textarea>
						</td>
					</tr>
					<tr>
						<th>処理方法</th>
						<td>
							<select id="outputWritingTimingSelect" data-option="outputWritingTiming">
								<option value="100000">100,000行ごとに書き込み</option>
								<option value="10000" selected>10,000行ごとに書き込み</option>
								<option value="1000">1,000行ごとに書き込み</option>
								<option value="100">100行ごとに書き込み</option>
								<option value="input">入力ファイル処理完了ごとに書き込み</option>
								<option value="all">最後に一括書き込み(書き出しを分割しない)</option>
							</select>
							<div class="tooltip">？<div class="tooltipText">
								大きな値を選択すると、処理が早くなりますが、メモリ使用量が増加します。<br>
								正常に処理できる範囲でもっとも大きな値を選択してください。<br>
								また、書き出しファイルに対してソート処理を行う場合は「最後に一括書き込み」とする必要があります。<br>
								処理するファイルが大きい場合はメモリ不足となる場合があります。
							</div></div>
						</td>
					</tr>
				</table>
				
				<h3>出力ファイル設定</h3>
				<div class="optionBox">ファイル名(振分・抽出)：<br>
					<textarea id="outputFileNameCodeInput" rows="2" cols="50" placeholder="出力ファイル名を返すコードを入力" data-option="outputFileNameCode">return ["output.csv"]</textarea>
				</div>
				<!-- 自動連番にも対応する -->
				<!-- 正規表現にも対応する -->
				<div class="optionSet">
					<label class="optionBox">
						<input type="checkbox" id="outputSplitCheckbox" data-option="outputSplit">ファイルを指定行数で分割する
					</label>
					<label class="optionBox">
						分割行数 : <input type="number" id="outputMaxRowsInput" value="0" style="width: 5em;" data-option="outputMaxRows">行
					</label>
				</div>
				<div class="optionSet">
					<span class="optionBox">
						すでにファイルが存在する場合
						<label><input type="radio" name="outputFileExistActionRadiobutton" value="overwrite" checked data-option="outputFileExistAction"> 上書き</label>
						<label><input type="radio" name="outputFileExistActionRadiobutton" value="append" data-option="outputFileExistAction"> 追記</label>
					</span>
				</div>
			</div>
			<div id="outputButtonBox">
				<div id="outputButton">処理開始</div>
				<div id="outputStatusTextBox">
					<span id="outputStatusText">ここに出力状況が表示されます。</span>
				</div>
			</div>
		</div>
	</div>
</body>
</html>